name: ci

on:
  push:
    branches:
      - 'main'

jobs:
  docker:
    runs-on: ubuntu-latest
    services:
      neuvector-scanner:
        image: neuvector/controller
        ports:
          - 18301:18301
          - 18300:18300
          - 18400:18400
          - 18301:18301/udp
          - 18300:18300/udp
          - 18400:18400/udp
          - 10443:10443
    env:
      NV_LOGIN_JSON: '{"password":{"username":"admin","password":"admin"}}'
      NV_SCANNING_JSON: '{"request":{"registry":"","username":"","password":"","repository":"bashofmann/neuvector-github-action-example","tag":"latest"}}'
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Build and push
        uses: docker/build-push-action@v3
        with:
          push: false
          tags: bashofmann/neuvector-github-action-example:latest
#      - docker run -itd --privileged --name neuvector.controller -e CLUSTER_JOIN_ADDR=$CI_SERVER_HOST -p 18301:18301 -p 18301:18301/udp -p 18300:18300 -p 18400:18400  -p $NV_PORT:$NV_PORT -v /var/neuvector:/var/neuvector -v /var/run/docker.sock:/var/run/docker.sock -v /proc:/host/proc:ro -v /sys/fs/cgroup/:/host/cgroup/:ro $NV_IMAGE
      - name: Login to NeuVector
        run: |
          _COUNTER_="0"
          while [ -z "$TOKEN" -a "$_COUNTER_" != "12" ]; do
            _COUNTER_=$((( _COUNTER_ + 1 )))
            sleep 5
            TOKEN=`(curl -s -f https://localhost:10443/v1/auth -k -H "Content-Type:application/json" -d $NV_LOGIN_JSON || echo null) | jq -r '.token.token'`
            if [ "$TOKEN" = "null" ]; then
              TOKEN=""
            fi
          done
          echo "TOKEN=$TOKEN" >> $GITHUB_ENV
      - name: Scanning
        run: |
          sleep 20
          curl https://localhost:10443/v1/scan/repository -s -k -H "Content-Type:application/json" -H "X-Auth-Token:$TOKEN" -d $NV_SCANNING_JSON | jq .
      - name: Logout
        run: |
          curl https://localhost:10443/v1/auth -k -X 'DELETE' -H "Content-Type:application/json" -H "X-Auth-Token:$TOKEN"